#!/usr/bin/env bash
set -exu

function tmux_default_command {
  if tmux show-options -gv default-command > /dev/null
  then
    tmux show-options -gv default-command
    exit 0
  fi

  if hash reattach-to-user-namespace 2> /dev/null
  then
    echo 'reattach-to-user-namespace -l bash'
  else
    echo 'bash'
  fi
}

function emacs_command {
  echo 'emacs'
}

function new_tmux {
  session_name=$1
  base_dir=$2

  default_command=$(tmux_default_command)
  default_command=${default_command:-}

  cd $base_dir

  tmux new-session -d -s $session_name -n editor "$default_command -c $(emacs_command); $default_command"
  tmux set-option -g default-command "$default_command"
  tmux new-window -t $session_name -n admin
  tmux new-window -t $session_name -n services
  tmux new-window -t $session_name -n db
  tmux select-window -t 1
  tmux select-window -t 0
  tmux attach
}

name=${1:-}
base_dir=${2:-}

if [[ ! -z $base_dir ]]
then
  new_tmux $name $base_dir
  exit 0
else
  name=${name:-default}
  base_dir=${base_dir:-$HOME}
fi

function tmux_sessions {
  if tmux ls -F'#{session_name}' > /dev/null
  then
    tmux ls -F'#{session_name}'
  fi
}

for s in $(tmux_sessions)
do
  if [[ $s == *$name* ]]
  then
    tmux attach -t $s
    exit 0
  fi
done

IFS=$(echo -en "\n\b")

git_projects=$(find ~ -name '.git' -type d -maxdepth 4)

for gp in $git_projects
do
  project_dir=$(dirname "$gp")
  project_name="$(basename $project_dir)"
  if [[ $project_name == *$name* ]]
  then
    new_tmux $project_name $project_dir
    exit 0
  fi
done

new_tmux $name $base_dir
