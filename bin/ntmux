#!/usr/bin/env bash
set -exu

NAME="${1:-}"
NAME_ARG="-s $NAME"
TARGET_ARG="-t $NAME"
WORKING_DIR="${2:-}"

if [ ! -z $WORKING_DIR ]
then
  cd $WORKING_DIR
fi

if [ -z $NAME ]
then
  NAME_ARG=""
  TARGET_ARG=""
fi

TMUX_SESSIONS=$(tmux ls -F'#{session_name}')

for s in $TMUX_SESSIONS
do
  if [[ $s == *$NAME* ]]
  then
    tmux att -t $s
    exit 0
  fi
done

GIT_PROJECTS=$(find ~ -name '.git' -type d -maxdepth 4)

for gp in $GIT_PROJECTS
do
  PROJECT_DIR=$(dirname $gp)
  PROJECT_NAME=$(basename $PROJECT_DIR)
  if [[ $PROJECT_NAME == *$NAME* ]]
  then
    cd $PROJECT_DIR
    tmux new -d -s $PROJECT_NAME -n editor 'reattach-to-user-namespace "bash -i -c emacs"; reattach-to-user-namespace -l bash'
    tmux neww -t $PROJECT_NAME -n admin
    tmux neww -t $PROJECT_NAME -n services
    tmux select-window -t 0
    tmux att
    exit 0
  fi
done

tmux new -d $NAME_ARG -n editor 'reattach-to-user-namespace -l bash -c emacs; reattach-to-user-namespace -l bash'
tmux neww $TARGET_ARG -n admin
tmux neww $TARGET_ARG -n services
tmux select-window -t 0
tmux att
